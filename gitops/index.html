<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.1, mkdocs-material-8.4.1"><title>GitOps approach - IBM - EDA - Real-time inventory demo</title><link rel=stylesheet href=../assets/stylesheets/main.69437709.min.css><link rel=stylesheet href=../assets/stylesheets/palette.cbb835fc.min.css><meta name=theme-color content=#000000><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../extra.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=black data-md-color-accent> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#gitops-approach class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="IBM - EDA - Real-time inventory demo" class="md-header__button md-logo" aria-label="IBM - EDA - Real-time inventory demo" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> IBM - EDA - Real-time inventory demo </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> GitOps approach </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/ibm-cloud-architecture/eda-rt-inventory-gitops title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="IBM - EDA - Real-time inventory demo" class="md-nav__button md-logo" aria-label="IBM - EDA - Real-time inventory demo" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> IBM - EDA - Real-time inventory demo </label> <div class=md-nav__source> <a href=https://github.com/ibm-cloud-architecture/eda-rt-inventory-gitops title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../demo-script/ class=md-nav__link> Demonstration script </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> GitOps approach <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> GitOps approach </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#what-is-covered class=md-nav__link> What is covered </a> </li> <li class=md-nav__item> <a href=#gitops-on-new-openshift-cluster class=md-nav__link> GitOps on new OpenShift Cluster </a> <nav class=md-nav aria-label="GitOps on new OpenShift Cluster"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#what-is-deployed-in-this-demonstration class=md-nav__link> What is deployed in this demonstration </a> </li> <li class=md-nav__item> <a href=#cp4integration-installation-considerations class=md-nav__link> CP4Integration installation considerations </a> </li> <li class=md-nav__item> <a href=#bootstrap-gitops class=md-nav__link> Bootstrap GitOps </a> </li> <li class=md-nav__item> <a href=#deploy-argocd-app-of-apps class=md-nav__link> Deploy ArgoCD app of apps: </a> </li> <li class=md-nav__item> <a href=#potential-errors class=md-nav__link> Potential errors </a> </li> <li class=md-nav__item> <a href=#configure-connector class=md-nav__link> Configure connector </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#deploy-in-an-existing-cp4i-deployment class=md-nav__link> Deploy in an existing CP4I deployment </a> <nav class=md-nav aria-label="Deploy in an existing CP4I deployment"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#bootstrap-gitops_1 class=md-nav__link> Bootstrap GitOps </a> </li> <li class=md-nav__item> <a href=#deploy-the-solution class=md-nav__link> Deploy the solution </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../mm2/ class=md-nav__link> Mirror Maker 2 </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/refarch-eda/ class=md-nav__link> Back to EDA </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#what-is-covered class=md-nav__link> What is covered </a> </li> <li class=md-nav__item> <a href=#gitops-on-new-openshift-cluster class=md-nav__link> GitOps on new OpenShift Cluster </a> <nav class=md-nav aria-label="GitOps on new OpenShift Cluster"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#what-is-deployed-in-this-demonstration class=md-nav__link> What is deployed in this demonstration </a> </li> <li class=md-nav__item> <a href=#cp4integration-installation-considerations class=md-nav__link> CP4Integration installation considerations </a> </li> <li class=md-nav__item> <a href=#bootstrap-gitops class=md-nav__link> Bootstrap GitOps </a> </li> <li class=md-nav__item> <a href=#deploy-argocd-app-of-apps class=md-nav__link> Deploy ArgoCD app of apps: </a> </li> <li class=md-nav__item> <a href=#potential-errors class=md-nav__link> Potential errors </a> </li> <li class=md-nav__item> <a href=#configure-connector class=md-nav__link> Configure connector </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#deploy-in-an-existing-cp4i-deployment class=md-nav__link> Deploy in an existing CP4I deployment </a> <nav class=md-nav aria-label="Deploy in an existing CP4I deployment"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#bootstrap-gitops_1 class=md-nav__link> Bootstrap GitOps </a> </li> <li class=md-nav__item> <a href=#deploy-the-solution class=md-nav__link> Deploy the solution </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/ibm-cloud-architecture/eda-rt-inventory-gitops/edit/master/docs/gitops/index.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1 id=gitops-approach>GitOps approach<a class=headerlink href=#gitops-approach title="Permanent link">&para;</a></h1> <h2 id=what-is-covered>What is covered<a class=headerlink href=#what-is-covered title="Permanent link">&para;</a></h2> <p>This GitOps supports bootstrapping the solution as a Day 1 operation, with the deployment of operators, secrets, pipelines... Then with Day 2 operations any changes to the configurations done in this repository, managed with the Git PR process, are propagated by ArgoCD to the runtime cluster.</p> <p>The GitOps approach is an adaptation of <a href=https://developers.redhat.com/articles/2021/07/21/bootstrap-gitops-red-hat-openshift-pipelines-and-kam-cli#a_gitops_approach_to_application_deployment>Red Hat's KAM practices</a> enhanced to be able to boostrap some important operators like the OpenShift GitOps Operator and OpenShift Pipelines Operator and Cloud Pak for integration operators.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>kam bootstrap <span class=se>\</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>--service-repo-url https://github.com/ibm-cloud-architecture/refarch-eda-store-inventory <span class=se>\</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>--gitops-repo-url  https://github.com/ibm-cloud-architecture/eda-rt-inventory-gitops <span class=se>\</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>--image-repo image-registry.openshift-image-registry.svc:5000/ibmcase/ <span class=se>\</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>--output eda-rt-inventory-gitops <span class=se>\</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>--git-host-access-token &lt;a-github-token&gt; <span class=se>\</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>--prefix edademo --push-to-git<span class=o>=</span><span class=nb>true</span>
</code></pre></div> <p>The generated content was enhanced to add boostraping configuration and scripts, the final repository structure includes:</p> <ul> <li><strong>Boostrap</strong> folder: to install different operators and to define the ArgoCD project named <code>rt-inventory</code>.</li> <li><strong>config</strong> folder, is for defining the ArgoCD apps and the app of apps. </li> <li><strong>kconnect</strong> folder is used to build a custom docker image of Kafka connector with MQ source, Elasticsearch sink and Cloud Object storage sink.</li> <li><strong>local-demo</strong> folder is for running the solution on your laptop using docker-compose.</li> <li><strong>environments</strong> folder, is the most important one, it uses <a href=https://kustomize.io/ >Kustomize</a> to declare environments (dev, staging) and component deployments (See next section for details). </li> </ul> <p>We also added a <code>Makefile</code> and scripts to deploy the gitops, pipelines operators and different elements with or without GitOps.</p> <p>In this Gitops you can use different approaches to deploy the real-time inventory solution depending of your existing environment.</p> <ul> <li><a href=#gitops-from-a-new-openshift-cluster>Start from an OpenShift Cluster without any Cloud Pak for Integration components</a>, this will take few hours to deploy as some Operator and Operand deployments may take time. </li> <li><a href=./#gitops-from-cp4i-deployment>Start from a Cloud Pak for integration deployed in cp4i-* projects</a></li> </ul> <h2 id=gitops-on-new-openshift-cluster>GitOps on new OpenShift Cluster<a class=headerlink href=#gitops-on-new-openshift-cluster title="Permanent link">&para;</a></h2> <p>This GitOps repository (represented as the yellow rectangle in figure below) defines the ArgoCD apps used to monitor and deploy the different microservices, streaming processing apps, and the different IBM products needed: Event Streams, MQ, API management, event-end-point management. The figure belows presents the adopted strategy:</p> <p><img alt src=images/gitops-catalog.png></p> <p>The <a href=https://github.com/ibm-cloud-architecture/eda-gitops-catalog.git>gitops catalog repository</a>, represented with a blue rectangle, defines the different operator subscriptions for the IBM Cloud Pak for Integration components. Centralizing to one repository such operator subscriptions enforces reuse between solutions.</p> <h3 id=what-is-deployed-in-this-demonstration>What is deployed in this demonstration<a class=headerlink href=#what-is-deployed-in-this-demonstration title="Permanent link">&para;</a></h3> <p>The development project includes event-streams, MQ, schema registry... </p> <p><img alt src=images/hl-view.png></p> <p>The installation approach is to deploy operators to manage All Namespaces, at the cluster scope. So only one Platform UI can be installed per cluster. A single instance of IBM Cloud Pak foundational services is installed in the <code>ibm-common-services</code> namespace.</p> <p>The following operators may be installed from this GitOps:</p> <ul> <li>ibm-integration-platform-navigator</li> <li>ibm-integration-asset-repository</li> <li>ibm-integration-operations-dashboard</li> <li>ibm-eventstreams</li> <li>ibm-mq</li> </ul> <p>The entitlement key secret will be copied to each namespace where some of the Cloud Pak integration products are deployed, using a kubernetes job.</p> <p>Part of this deployment will be based on commands run from your laptop, part as pipelines, and part as ArgoCD apps. The approach is based on the following:</p> <ul> <li>secrets, and operators deployments to bootstrap the CI/CD are configured with Makefile and commands. Operators are deployed in <code>openshift-operators</code>.</li> <li>Tekton pipelines are used to deploy some CP4I operators</li> <li>ArgoCD apps are used to deploy CP4I operands: the use of ArgoCD for this, is justified for Day 2 operations. </li> </ul> <p>The pipelines are using a service account, named <code>pipeline</code>, in the <code>rt-inventory-cicd</code> project, and cluster role to access different resources cross namespaces.</p> <h3 id=cp4integration-installation-considerations>CP4Integration installation considerations<a class=headerlink href=#cp4integration-installation-considerations title="Permanent link">&para;</a></h3> <ul> <li>In this solution, CP4I operators are deployed in <strong>All namespaces</strong>, the entire OpenShift cluster effectively behaves as one large tenant.</li> <li>With <strong>All namespace</strong> there can be only one Platform Navigator installed per cluster, and all Cloud Pak instances are owned by that Platform Navigator. </li> <li>A single instance of IBM Cloud Pak foundational services is installed in the <code>ibm-common-services</code> namespace if the foundational services operator is not already installed on the cluster.</li> <li>Operators can be upgraded automatically when new compatible versions are available. For production deployment, the manual upgrade may be desirable.</li> </ul> <h3 id=bootstrap-gitops>Bootstrap GitOps<a class=headerlink href=#bootstrap-gitops title="Permanent link">&para;</a></h3> <p>The current GitOps was run on OpenShift 4.8.</p> <ul> <li>Login to the OpenShift Console, and get login token to be able to use <code>oc cli</code></li> <li> <p>Obtain your <a href=https://github.com/IBM/cloudpak-gitops/blob/main/docs/install.md#obtain-an-entitlement-key>IBM license entitlement key</a> and export as KEY environment variables</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=nb>export</span> <span class=nv>KEY</span><span class=o>=</span>&lt;yourentitlementkey&gt;
</code></pre></div> </li> <li> <p>create <code>github-credentials.yaml</code> file for the git secret based on <a href=https://github.com/ibm-cloud-architecture/eda-rt-inventory-gitops/template-github-credentials.yaml><code>template-github-credentials.yaml</code></a>. Use your github personal access token. It will be used by the pipeline runs.</p> </li> <li>create a Secret for your IBM Cloud Object Storage credential. Use the on <a href=https://github.com/ibm-cloud-architecture/eda-rt-inventory-gitops/template-cos-credentials.yaml><code>template-cos-credentials.yaml</code></a> and modify the following parameters: </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=w>  </span><span class=nt>cos.api.key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;cos-credential.field.apikey&gt;</span><span class=w></span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>  </span><span class=nt>cos.bucket.location</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;region where the cos bucket is&gt;</span><span class=w></span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>  </span><span class=nt>cos.bucket.name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;bucketname&gt;</span><span class=w></span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>  </span><span class=nt>cos.service.crn</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;cos-credential.field.iam_serviceid_crn&gt;</span><span class=w></span>
</code></pre></div> <ul> <li>If not done already, use the following command to install GitOps and Pipeline operators, entitlement key, and IBM image catalog: </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a> make prepare
</code></pre></div> <p>Once the operators are running the command: <code>oc get pods -n openshift-gitops</code> should return a list of pods like:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>  NAME                                                          READY   STATUS    RESTARTS   AGE
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>  openshift-gitops-application-controller-0                     <span class=m>1</span>/1     Running   <span class=m>0</span>          4h5m
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>  openshift-gitops-applicationset-controller-6948bcf87c-jdv2x   <span class=m>1</span>/1     Running   <span class=m>0</span>          4h5m
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>  openshift-gitops-dex-server-64cbd8d7bd-76czz                  <span class=m>1</span>/1     Running   <span class=m>0</span>          4h5m
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>  openshift-gitops-redis-7867d74fb4-dssr2                       <span class=m>1</span>/1     Running   <span class=m>0</span>          4h5m
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>  openshift-gitops-repo-server-6dc777c845-gdjhr                 <span class=m>1</span>/1     Running   <span class=m>0</span>          4h5m
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>  openshift-gitops-server-7957cc47d9-cmxvw                      <span class=m>1</span>/1     Running   <span class=m>0</span>          4h5m
</code></pre></div> <ul> <li>Deploy different IBM product Operators (Event Streams, MQ...) to monitor <code>All Namespaces</code>:</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>make install_cp4i_operators
</code></pre></div> <p>The IBM common services deployment can take more than 30 minutes.</p> <ul> <li>Get the ArgoCD User Interface URL and open a web browser:</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>chrome https://<span class=k>$(</span>oc get route openshift-gitops-server -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.ingress[].host}&#39;</span>  -n openshift-gitops<span class=k>)</span>
</code></pre></div> <h3 id=deploy-argocd-app-of-apps>Deploy ArgoCD app of apps:<a class=headerlink href=#deploy-argocd-app-of-apps title="Permanent link">&para;</a></h3> <ul> <li>To start the Continuous Deployment with ArgoCD, just executing the following command should deploy event streams cluster instance, MQ broker, kafka connect, and the different microservices.</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>oc apply -k config/argocd
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=c1># Or</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>make start_argocd_apps
</code></pre></div> <p>The expected set of ArgoCD apps looks like:</p> <p><img alt src=images/rt-inv-argoapps.png></p> <ul> <li><strong>rt-inventory-Argo-app</strong> is an app of apps</li> <li><strong>rt-inventory-dev-env</strong> is for the rt-inventory-dev namespace</li> <li><strong>rt-inventory-dev-services</strong> is for event streams, kafka connect cluster and mq deployments in dev-env namespace</li> <li><strong>rt-inventory-store-simulator-app</strong> is for the simulator app used in the demo.</li> <li><strong>rt-inventory-item-inventory</strong> for the item aggregator application</li> <li><strong>rt-inventory-store-inventory</strong> for the store aggregator application</li> </ul> <h3 id=potential-errors>Potential errors<a class=headerlink href=#potential-errors title="Permanent link">&para;</a></h3> <ul> <li> <p>"ConfigMap ibm-common-services-status in <strong>kube-public</strong> to be ready"</p> <ul> <li>While the Event Streams cluster is created: An unexpected exception was encountered: Exceeded timeout of 1200000ms while waiting for ConfigMap resource <strong>ibm-common-services-status</strong> in namespace <strong>kube-public</strong> to be ready. More detail can be found in the Event Streams Operator log.</li> <li>This is an issue known as of 10.5. Restart the ES operator pod</li> <li>See also https://github.ibm.com/mhub/qp-planning/issues/7383</li> </ul> </li> </ul> <h3 id=configure-connector>Configure connector<a class=headerlink href=#configure-connector title="Permanent link">&para;</a></h3> <ul> <li>Go to the dev project: <code>oc project rt-inventory-dev</code></li> <li> <p>Deploy the sink kafka connector for cloud object storage:</p> </li> <li> <p>Modify the file <code>kafka-cos-sink-connector.yaml</code> in <code>environments/rt-inventory-dev/apps/cos-sink</code>, by replacing the following line from the cloud object storage credentials:</p> </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=w>  </span><span class=nt>cos.api.key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">IBM_COS_API_KEY</span><span class=w></span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=w>  </span><span class=nt>cos.bucket.location</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">IBM_COS_BUCKET_LOCATION</span><span class=w></span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=w>  </span><span class=nt>cos.bucket.name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">IBM_COS_BUCKET_NAME</span><span class=w></span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=w>  </span><span class=nt>cos.bucket.resiliency</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">IBM_COS_RESILIENCY</span><span class=w></span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=w>  </span><span class=nt>cos.service.crn</span><span class=p>:</span><span class=w> </span><span class=s>&quot;IBM_COS_CRM&quot;</span><span class=w></span>
</code></pre></div> <ul> <li> <p>Then deploy the connector: <code>oc apply -f environments/rt-inventory-dev/apps/cos-sink/kafka-cos-sink-connector.yaml</code></p> </li> <li> <p>Deploy the MQ source connector</p> </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>oc apply -f environments/rt-inventory-dev/apps/mq-source/kafka-mq-src-connector.json
</code></pre></div> <ul> <li>Access to the Simulator User Interface via:</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>chrome http://<span class=k>$(</span>oc get route store-simulator -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.ingress[].host}&#39;</span><span class=k>)</span>
</code></pre></div> <ul> <li>Access Event Stream Console:</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>chrome https://<span class=k>$(</span>oc get route dev-ibm-es-ui -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.ingress[].host}&#39;</span><span class=k>)</span>
</code></pre></div> <ul> <li>Access to IBM MQ Admin Console</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>chrome https://<span class=k>$(</span>oc get route store-mq-ibm-mq-qm -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.ingress[].host}&#39;</span><span class=k>)</span>
</code></pre></div> <h2 id=deploy-in-an-existing-cp4i-deployment>Deploy in an existing CP4I deployment<a class=headerlink href=#deploy-in-an-existing-cp4i-deployment title="Permanent link">&para;</a></h2> <p>In this section we suppose CP4I is already deployed in <code>cp4i</code> namespace, event streams in <code>cp4i-eventstreams</code> project. So somewhere someone has already deployed the infrastructure, and other components as multi tenants. (This is represented as the green rectangles in the figure below)</p> <p><img alt src=images/gitops-multi-tenants.png></p> <p>Some particularities:</p> <ul> <li>Event Streams is in its own project, so kafka topics, kafka users has to follow a naming convention to avoid colision with other teams / solutions.</li> <li>MQ broker runs local to the solution namespace. (<code>rt-inventory-dev</code> has its own MQ Broker)</li> </ul> <p>The command below will not use GitOpa / ArgoCD</p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>make multi-tenants
</code></pre></div> <ul> <li>Get Store Simulator URL and execute the demonstration script:</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>chrome <span class=k>$(</span>oc get routes store-simulator -o <span class=nv>jsonpath</span><span class=o>=</span><span class=err>&#39;</span><span class=o>{</span>.status.ingress<span class=o>[]</span>.host<span class=o>}</span><span class=p>;</span><span class=k>)</span>
</code></pre></div> <h3 id=bootstrap-gitops_1>Bootstrap GitOps<a class=headerlink href=#bootstrap-gitops_1 title="Permanent link">&para;</a></h3> <ul> <li>Login to the OpenShift Console, and get login token to be able to use <code>oc cli</code></li> <li>If not done already, use the script to install GitOps and Pipeline operators:</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>make verify_argocd
</code></pre></div> <ul> <li>Create an ArgoCD project named <code>rt-inventory</code></li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a>oc apply -k bootstrap/argocd-project
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=c1># Result</span>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>appproject.argoproj.io/rt-inventory created
</code></pre></div> <ul> <li> <p>To get the <code>admin</code> user's password use the command</p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>oc extract secret/openshift-gitops-cluster -n openshift-gitops --to<span class=o>=</span>-
</code></pre></div> </li> <li> <p>Get the ArgoCD User Interface URL and open a web browser</p> </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a>chrome https://<span class=k>$(</span>oc get route openshift-gitops-server -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.ingress[].host}&#39;</span>  -n openshift-gitops<span class=k>)</span>
</code></pre></div> <h3 id=deploy-the-solution>Deploy the solution<a class=headerlink href=#deploy-the-solution title="Permanent link">&para;</a></h3> <ul> <li>To start the Continuous Deployment with ArgoCD, just executing the following command should deploy different microservices under rt-inventory-dev project using event-streams, MQ.. from another project (e.g. cp4i).</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a>oc apply -k config/cp4i-deploy
</code></pre></div> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../demo-script/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Demonstration script" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Demonstration script </div> </div> </a> <a href=../mm2/ class="md-footer__link md-footer__link--next" aria-label="Next: Mirror Maker 2" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Mirror Maker 2 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["content.code.annotate", "content.tooltips", "navigation.instant", "navigation.indexes", "navigation.tracking", "navigation.tabs.sticky"], "search": "../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../assets/javascripts/bundle.9c69f0bc.min.js></script> </body> </html>